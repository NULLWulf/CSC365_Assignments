<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="../css/homepage.css" />
    <script src="../js/homepage.js" defer></script>
    <meta charset="UTF-8" />
    <title>Yelp Similarity Tester</title>
  </head>
  <body>
    <div style="width: 50%; font-size: 14px">
      <h1>Yelp Dataset Recommendation Engine</h1>
      <p style="font-size: 14px">
        Select an item from the dropdown to get a randomly related business. The
        relation is determined by a correlation of terms found within the
        businesses' starss. (Both the selected, and 'related' businesses)
      </p>
      <select id="businesses"></select>
      <div class="details-box" style="display: none">
        <h2>Details</h2>
        <h3>Selected Business</h3>
        <p id="selected-name"></p>
        <p id="selected-city"></p>
        <p id="selected-state"></p>
        <p id="selected-lat"></p>
        <p id="selected-long"></p>
        <p id="selected-stars"></p>
<h3>Related Business</h3>
        <p id="related-name"></p>
        <p id="related-city"></p>
        <p id="related-state"></p>
        <p id="related-lat"></p>
        <p id="related-long"></p>
        <p id="related-stars"></p>
        <h3>Cluster Medoid Business</h3>
        <p id="medoid-name"></p>
        <p id="medoid-city"></p>
        <p id="medoid-state"></p>
        <p id="medoid-lat"></p>
        <p id="medoid-long"></p>
        <p id="medoid-stars"></p>
      </div>
      <h2>Calculation Process</h2>
    </div>

    <script>
      let select = document.getElementById("businesses");
      let detailsBox = document.querySelector(".details-box");

      // function to get random business list and populate select element
      function getBusinessList() {
        fetch("/random")
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            // filter out empty values
            let businesses = data.filter(
              (business) => business.name.trim() !== ""
            );
            // populate select element
            console.log(businesses);
            businesses.forEach((business) => {
              let option = document.createElement("option");

              option.value = business.name;
              option.text = business.name;
              let input = document.createElement("input");
              input.type = "hidden";
              input.name = "file_id";
              input.value = business.file_id;
              console.log(input);
              option.appendChild(input);

              select.add(option);
            });
          })
          .catch((error) => console.error(error));
      }

      select.addEventListener("change", () => {
        let selectedOption = select.options[select.selectedIndex];
        let businessId = selectedOption.querySelector(
          '[name="file_id"]'
        ).value;
        fetch(`/clustered?file_id=${businessId}`)
          .then((response) => response.json())
          .then((data) => {
            console.log(data);

            // update the details box with the relevant information

        let selectedBiz = data.business_selected;
        let medoidBiz = data.business_medoid;
        let relatedBiz = data.businesses_similar;

        document.getElementById("selected-name").textContent = `Selected Business: ${selectedBiz.name}`;
        document.getElementById("selected-city").textContent = `City: ${selectedBiz.city}`;
        document.getElementById("selected-state").textContent = `State: ${selectedBiz.state}`;
        document.getElementById("selected-lat").textContent = `Latitude: ${selectedBiz.latitude}`;
        document.getElementById("selected-long").textContent = `Longitude: ${selectedBiz.longitude}`;
        document.getElementById("selected-stars").textContent = `stars: ${selectedBiz.stars}`;

        document.getElementById("medoid-name").textContent = `Medoid Business: ${medoidBiz.name}`;
        document.getElementById("medoid-city").textContent = `City: ${medoidBiz.city}`;
        document.getElementById("medoid-state").textContent = `State: ${medoidBiz.state}`;
        document.getElementById("medoid-lat").textContent = `Latitude: ${medoidBiz.latitude}`;
        document.getElementById("medoid-long").textContent = `Longitude: ${medoidBiz.longitude}`;
        document.getElementById("medoid-stars").textContent = `stars: ${medoidBiz.stars}`;

        document.getElementById("related-name").textContent = `Related Business: ${relatedBiz.name}`;
        document.getElementById("related-city").textContent = `City: ${relatedBiz.city}`;
        document.getElementById("related-state").textContent = `State: ${relatedBiz.state}`;
        document.getElementById("related-lat").textContent = `Latitude: ${relatedBiz.latitude}`;
        document.getElementById("related-long").textContent = `Longitude: ${relatedBiz.longitude}`;
        document.getElementById("related-stars").textContent = `stars: ${relatedBiz.stars}`;

        detailsBox.style.display = "block";
      })
      .catch((error) => console.error(error));
  });

  // call getBusinessList on page load
  window.onload = getBusinessList;
</script>
